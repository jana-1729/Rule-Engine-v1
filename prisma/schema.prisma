// Prisma Schema v2 - B2B2C Embedded Integration Platform
// Architecture: Account → Apps → End Users → Connections

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// PLATFORM LAYER - Your Customers (Companies)
// ============================================

model Account {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String   // Company name
  slug      String   @unique
  
  // Subscription & Billing
  plan      String   @default("free") // free, starter, pro, enterprise
  status    String   @default("active") // active, suspended, cancelled
  
  // Limits
  monthlyExecutionLimit Int      @default(10000)
  monthlyExecutionsUsed Int      @default(0)
  
  // Auth
  passwordHash String
  emailVerified Boolean  @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  apps              App[]
  users             AccountUser[] // Team members at Company X
  auditLogs         AuditLog[]
  
  @@index([email])
  @@index([slug])
  @@map("accounts")
}

model AccountUser {
  id         String   @id @default(cuid())
  accountId  String
  email      String
  name       String?
  role       String   @default("member") // owner, admin, member, viewer
  
  passwordHash String?
  inviteToken  String?  @unique
  invitedAt    DateTime?
  joinedAt     DateTime?
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  account    Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  @@unique([accountId, email])
  @@index([accountId])
  @@map("account_users")
}

// ============================================
// APP LAYER - Your Customer's Products
// ============================================

model App {
  id          String   @id @default(cuid())
  accountId   String
  
  name        String   // "X Product"
  description String?
  
  // API Credentials for Company X
  appId       String   @unique @default(cuid()) // Public identifier
  apiKey      String   @unique // Secret API key (hashed)
  
  // Configuration
  webhookUrl  String?  // Where to send event notifications
  webhookSecret String?
  
  // Settings
  allowedOrigins String[] // CORS origins
  rateLimitPerMinute Int   @default(100)
  
  // Status
  status      String   @default("active") // active, paused, suspended
  
  // Usage tracking
  totalExecutions     Int      @default(0)
  totalEndUsers       Int      @default(0)
  totalConnections    Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  account         Account           @relation(fields: [accountId], references: [id], onDelete: Cascade)
  endUsers        EndUser[]
  connections     EndUserConnection[]
  executions      Execution[]
  enabledIntegrations AppIntegration[]
  
  @@index([accountId])
  @@index([appId])
  @@index([apiKey])
  @@map("apps")
}

model AppIntegration {
  id            String   @id @default(cuid())
  appId         String
  integrationId String   // Reference to integration catalog
  
  // Custom configuration per app
  enabled       Boolean  @default(true)
  customName    String?  // Custom display name
  customIcon    String?
  
  // App-specific credentials (if needed)
  // e.g., Company X's Slack workspace credentials for workspace-level actions
  appCredentials Json?
  
  createdAt     DateTime @default(now())
  
  app           App      @relation(fields: [appId], references: [id], onDelete: Cascade)
  integration   Integration @relation(fields: [integrationId], references: [id])
  
  @@unique([appId, integrationId])
  @@index([appId])
  @@map("app_integrations")
}

// ============================================
// END USER LAYER - Your Customer's Customers
// ============================================

model EndUser {
  id              String   @id @default(cuid())
  appId           String
  
  // End user identifier (from Company X's system)
  externalId      String   // Company X's user ID
  email           String?
  name            String?
  
  // Metadata from Company X
  metadata        Json?    // Any custom data Company X wants to store
  
  // Status
  status          String   @default("active") // active, inactive, deleted
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  lastActiveAt    DateTime?

  // Relations
  app             App                 @relation(fields: [appId], references: [id], onDelete: Cascade)
  connections     EndUserConnection[]
  executions      Execution[]
  
  @@unique([appId, externalId])
  @@index([appId])
  @@index([externalId])
  @@map("end_users")
}

// ============================================
// INTEGRATION CATALOG
// ============================================

model Integration {
  id          String   @id @default(cuid())
  slug        String   @unique // slack, notion, google_sheets
  name        String
  description String?
  category    String   // communication, productivity, crm, etc.
  
  // Display
  logo        String?
  color       String?
  website     String?
  
  // Auth configuration
  authType    String   // oauth2, api_key, basic, custom
  authConfig  Json     // OAuth URLs, scopes, etc.
  
  // Available actions & triggers
  actions     Json     // List of available actions
  triggers    Json?    // List of available triggers
  
  // Status
  status      String   @default("available") // available, beta, deprecated
  version     String   @default("1.0.0")
  
  // Requirements
  requiresEndUserAuth Boolean @default(true) // Does each end-user need to connect?
  requiresAppAuth     Boolean @default(false) // Does the app need credentials?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  connections EndUserConnection[]
  executions  Execution[]
  appIntegrations AppIntegration[]
  
  @@index([slug])
  @@index([category])
  @@map("integrations")
}

// ============================================
// CONNECTIONS - End User's OAuth/API Keys
// ============================================

model EndUserConnection {
  id            String   @id @default(cuid())
  appId         String
  endUserId     String
  integrationId String
  
  // Connection name (user-friendly)
  name          String   // "My Slack Workspace"
  
  // Encrypted credentials
  credentials   Json     // { accessToken, refreshToken, etc. }
  encryptedData String?  @db.Text // Encrypted sensitive data
  
  // OAuth metadata
  scopes        String[]
  expiresAt     DateTime?
  
  // Status
  status        String   @default("active") // active, expired, revoked, error
  lastUsedAt    DateTime?
  lastSyncedAt  DateTime?
  
  // Error tracking
  errorCount    Int      @default(0)
  lastError     Json?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  app           App         @relation(fields: [appId], references: [id], onDelete: Cascade)
  endUser       EndUser     @relation(fields: [endUserId], references: [id], onDelete: Cascade)
  integration   Integration @relation(fields: [integrationId], references: [id])
  executions    Execution[]
  
  @@unique([appId, endUserId, integrationId])
  @@index([appId])
  @@index([endUserId])
  @@index([integrationId])
  @@index([status])
  @@map("end_user_connections")
}

// ============================================
// EXECUTION & LOGS
// ============================================

model Execution {
  id            String   @id @default(cuid())
  appId         String
  endUserId     String
  connectionId  String
  integrationId String
  
  // What was executed
  action        String   // e.g., "send_message", "create_page"
  
  // Input/Output
  input         Json
  output        Json?
  
  // Timing
  startedAt     DateTime @default(now())
  finishedAt    DateTime?
  duration      Int?     // milliseconds
  
  // Status
  status        String   // success, failed, pending, timeout
  
  // Error details
  errorCode     String?
  errorMessage  String?  @db.Text
  errorDetails  Json?
  
  // Retry tracking
  retryCount    Int      @default(0)
  maxRetries    Int      @default(3)
  
  // Request metadata
  requestId     String   @unique @default(cuid())
  ipAddress     String?
  userAgent     String?
  
  // Billing
  billedAt      DateTime?
  cost          Float?   // In credits/units
  
  createdAt     DateTime @default(now())

  // Relations
  app           App                 @relation(fields: [appId], references: [id], onDelete: Cascade)
  endUser       EndUser             @relation(fields: [endUserId], references: [id], onDelete: Cascade)
  connection    EndUserConnection   @relation(fields: [connectionId], references: [id])
  integration   Integration         @relation(fields: [integrationId], references: [id])
  
  @@index([appId])
  @@index([endUserId])
  @@index([integrationId])
  @@index([status])
  @@index([startedAt])
  @@index([requestId])
  @@map("executions")
}

// ============================================
// WEBHOOKS - Event notifications to Company X
// ============================================

model WebhookEvent {
  id            String   @id @default(cuid())
  appId         String
  
  // Event details
  eventType     String   // execution.success, execution.failed, connection.created, etc.
  payload       Json
  
  // Delivery
  status        String   @default("pending") // pending, sent, failed
  attempts      Int      @default(0)
  maxAttempts   Int      @default(3)
  
  // Response tracking
  responseStatus Int?
  responseBody   String?  @db.Text
  lastAttemptAt  DateTime?
  
  createdAt     DateTime @default(now())
  
  @@index([appId])
  @@index([status])
  @@index([eventType])
  @@map("webhook_events")
}

// ============================================
// AUDIT & ANALYTICS
// ============================================

model AuditLog {
  id            String   @id @default(cuid())
  accountId     String
  appId         String?
  userId        String?  // AccountUser or EndUser
  
  // Action details
  action        String   // app.created, connection.authorized, execution.triggered
  resource      String   // app, connection, execution
  resourceId    String?
  
  // Changes
  changes       Json?
  
  // Request context
  ipAddress     String?
  userAgent     String?
  
  createdAt     DateTime @default(now())

  account       Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  @@index([accountId])
  @@index([appId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

model UsageMetric {
  id            String   @id @default(cuid())
  accountId     String
  appId         String?
  
  // Metric type
  metricType    String   // executions, end_users, connections, api_calls
  value         Int
  
  // Dimensions
  integrationId String?
  
  // Time period (hourly aggregation)
  periodStart   DateTime
  periodEnd     DateTime
  
  createdAt     DateTime @default(now())

  @@unique([accountId, appId, metricType, periodStart])
  @@index([accountId])
  @@index([appId])
  @@index([metricType])
  @@index([periodStart])
  @@map("usage_metrics")
}

// ============================================
// OAUTH STATES - For secure OAuth flows
// ============================================

model OAuthState {
  id            String   @id @default(cuid())
  state         String   @unique // Random state parameter
  
  // Context
  appId         String
  endUserId     String
  integrationId String
  
  // Redirect
  redirectUri   String   // Where to redirect after OAuth
  
  // Security
  codeVerifier  String?  // For PKCE
  
  // Expiry
  expiresAt     DateTime
  usedAt        DateTime?
  
  createdAt     DateTime @default(now())
  
  @@index([state])
  @@index([expiresAt])
  @@map("oauth_states")
}

// ============================================
// API KEYS - For token rotation
// ============================================

model ApiKeyVersion {
  id        String   @id @default(cuid())
  appId     String
  
  keyHash   String   @unique
  keyPrefix String   // First 8 chars for identification
  
  status    String   @default("active") // active, revoked
  
  lastUsedAt DateTime?
  expiresAt  DateTime?
  
  createdAt DateTime @default(now())
  revokedAt DateTime?
  
  @@index([appId])
  @@index([keyHash])
  @@map("api_key_versions")
}

